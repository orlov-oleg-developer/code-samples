<!DOCTYPE html>
<html>

<head>
    <title>Simple Rive Extractor (No SM)</title>
    <script src="https://unpkg.com/@rive-app/canvas@2.17.0"></script>
</head>

<body>
    <input type="file" id="file" accept=".riv">
    <button onclick="extract()">Извлечь</button>
    <div id="status"></div>
    <canvas id="canvas" width="400" height="400"></canvas>
    <img id="result">

    <script>
        async function extract() {
            const file = document.getElementById('file').files[0];
            if (!file) return;

            const canvas = document.getElementById('canvas');
            const status = document.getElementById('status');

            const buffer = await file.arrayBuffer();

            const r = new rive.Rive({
                buffer: buffer,
                canvas: canvas,
                autoplay: false,
                layout: new rive.Layout({
                    fit: rive.Fit.Contain,
                    alignment: rive.Alignment.Center
                }),
                onLoad: () => {
                    console.log('Загружено!');

                    // Пробуем запустить hover анимацию напрямую
                    if (r.animationNames.includes('hover')) {
                        console.log('Найдена анимация hover, запускаем её');
                        r.play('hover');
                    } else {
                        console.log('Запускаем все анимации');
                        r.play();
                    }

                    // Сразу начинаем захват
                    setTimeout(() => {
                        const spriteCanvas = document.createElement('canvas');
                        spriteCanvas.width = 4000;
                        spriteCanvas.height = 1200;
                        const ctx = spriteCanvas.getContext('2d');

                        let frame = 0;
                        const maxFrames = 30;

                        function capture() {
                            if (frame >= maxFrames) {
                                document.getElementById('result').src = spriteCanvas.toDataURL();

                                const link = document.createElement('a');
                                link.download = 'sprite.png';
                                link.href = spriteCanvas.toDataURL();
                                link.click();

                                status.innerHTML = 'Готово!';
                                return;
                            }

                            const col = frame % 10;
                            const row = Math.floor(frame / 10);
                            ctx.drawImage(canvas, col * 400, row * 400);

                            status.innerHTML = `Кадр ${frame + 1}/${maxFrames}`;
                            frame++;

                            setTimeout(capture, 100);
                        }

                        capture();
                    }, 200);
                }
            });
        }
    </script>
</body>

</html>
